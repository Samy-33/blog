on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Switch to deploy branch
        uses: actions/checkout@v4
        with:
          ref: deploy
      - name: Merge main into deploy
        run: git merge main
      - name: Setup babashka
        # You may pin to the exact commit or the version.
        # uses: just-sultanov/setup-babashka@4aac6224e2b70964bc51b85f0f31bd1505a3f36d
        uses: just-sultanov/setup-babashka@v2
        with:
        # A desired version of babashka to install
          version: 1.3.86
      - name: clean
        run: bb quickblog clean
      - name: build
        run: bb quickblog render
      - name: export commit time
        run: export COMMIT_TIME=$(git log -1 --format=%cd --date=format:"%d-%m-%Y %H:%M:%S" | cat)
      - name: commit
        run: git add * && git commit -m "deploy @ ${COMMIT_TIME}"
  updateBranch:
    name: Update deploy branch
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
    - uses: Embraser01/update-git-branch-action@v1.0.0
      if: github.ref == 'refs/heads/master'
      with:
        branch: staging
        force: 1 # To push-force to the branch
        githubToken: ${{ secrets.PAT_TOKEN }} # Github Token

  
